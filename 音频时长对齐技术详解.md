# ğŸµ éŸ³é¢‘æ—¶é•¿å¯¹é½æŠ€æœ¯è¯¦è§£

## ğŸ“Š æ ¸å¿ƒåŸç†

### 1. **æ—¶é—´æ¯”ä¾‹è®¡ç®—**

éŸ³é¢‘æ—¶é•¿å¯¹é½çš„æ ¸å¿ƒæ˜¯è®¡ç®—**é€Ÿåº¦å€ç‡**ï¼š

```python
current_duration = len(audio) / 1000.0  # åˆæˆéŸ³é¢‘çš„å®é™…æ—¶é•¿ï¼ˆç§’ï¼‰
target_duration = end_time - start_time  # å­—å¹•æ—¶é—´æ®µçš„ç›®æ ‡æ—¶é•¿ï¼ˆç§’ï¼‰
speed_rate = current_duration / target_duration  # é€Ÿåº¦è°ƒæ•´å€ç‡
```

### 2. **æ—¶é—´æ¯”ä¾‹å…³ç³»**

| æƒ…å†µ | é€Ÿåº¦å€ç‡ | è°ƒæ•´æ•ˆæœ | ç¤ºä¾‹ |
|------|---------|---------|------|
| **åˆæˆéŸ³é¢‘å¤ªé•¿** | `speed_rate > 1.0` | åŠ é€Ÿæ’­æ”¾ | 5ç§’éŸ³é¢‘å‹ç¼©åˆ°3ç§’ â†’ å€ç‡1.67 |
| **åˆæˆéŸ³é¢‘å¤ªçŸ­** | `speed_rate < 1.0` | å‡é€Ÿæ’­æ”¾ | 2ç§’éŸ³é¢‘æ‹‰ä¼¸åˆ°3ç§’ â†’ å€ç‡0.67 |
| **æ—¶é•¿åˆšå¥½** | `speed_rate â‰ˆ 1.0` | ä¸è°ƒæ•´ | 3ç§’éŸ³é¢‘å¯¹åº”3ç§’å­—å¹• â†’ å€ç‡1.0 |

## ğŸ”§ æŠ€æœ¯å®ç°

### 1. **WSOLAç®—æ³•**

ä½¿ç”¨ **WSOLA (Waveform Similarity Overlap-Add)** ç®—æ³•ï¼š

```python
# ä½¿ç”¨audiotsmåº“çš„WSOLAå®ç°
reader = audiotsm.io.wav.WavReader(temp_wav_for_speed)
writer = audiotsm.io.wav.WavWriter(output_file, 1, 16000)

# åˆ›å»ºWSOLAå¤„ç†å™¨ï¼ŒæŒ‡å®šé€Ÿåº¦å€ç‡
wsola = audiotsm.wsola(1, speed=speed_rate)
wsola.run(reader, writer)
```

**WSOLAç®—æ³•ä¼˜åŠ¿**ï¼š
- âœ… **ä¿æŒéŸ³è°ƒ**ï¼šä¸ä¼šå› å˜é€Ÿè€Œæ”¹å˜éŸ³è°ƒ
- âœ… **é«˜è´¨é‡**ï¼šå‡å°‘éŸ³è´¨å¤±çœŸ
- âœ… **è‡ªç„¶æ•ˆæœ**ï¼šå¬èµ·æ¥æ›´è‡ªç„¶

### 2. **å®¹å·®æœºåˆ¶**

```python
if abs(speed_rate - 1.0) < 0.1:  # 10%å®¹å·®
    print("â­ï¸ é€Ÿåº¦å·®å¼‚å°äº10%ï¼Œç›´æ¥å¤åˆ¶æ–‡ä»¶")
    audio.export(output_file, format="wav")
    return True
```

**æ™ºèƒ½ä¼˜åŒ–**ï¼š
- å·®å¼‚å°äº10%æ—¶ä¸è¿›è¡Œè°ƒæ•´
- é¿å…ä¸å¿…è¦çš„å¤„ç†
- ä¿æŒåŸå§‹éŸ³è´¨

## ğŸ“ˆ å®é™…åº”ç”¨ç¤ºä¾‹

### ç¤ºä¾‹1ï¼šéŸ³é¢‘åŠ é€Ÿ
```
åŸå§‹æƒ…å†µï¼š
- å­—å¹•æ—¶é—´æ®µï¼š00:01:30 â†’ 00:01:33 (3ç§’)
- åˆæˆéŸ³é¢‘æ—¶é•¿ï¼š5ç§’
- é€Ÿåº¦å€ç‡ï¼š5/3 = 1.67

å¤„ç†ç»“æœï¼š
- éŸ³é¢‘åŠ é€Ÿ1.67å€
- æœ€ç»ˆæ—¶é•¿ï¼š5/1.67 â‰ˆ 3ç§’
- å®Œç¾åŒ¹é…å­—å¹•æ—¶é—´æ®µ
```

### ç¤ºä¾‹2ï¼šéŸ³é¢‘å‡é€Ÿ
```
åŸå§‹æƒ…å†µï¼š
- å­—å¹•æ—¶é—´æ®µï¼š00:02:10 â†’ 00:02:15 (5ç§’)
- åˆæˆéŸ³é¢‘æ—¶é•¿ï¼š3ç§’
- é€Ÿåº¦å€ç‡ï¼š3/5 = 0.6

å¤„ç†ç»“æœï¼š
- éŸ³é¢‘å‡é€Ÿ0.6å€ï¼ˆæ‹‰ä¼¸ï¼‰
- æœ€ç»ˆæ—¶é•¿ï¼š3/0.6 = 5ç§’
- å®Œç¾åŒ¹é…å­—å¹•æ—¶é—´æ®µ
```

## ğŸ¯ ä¼˜åŒ–åçš„å¤„ç†æµç¨‹

### æ—§æµç¨‹ï¼ˆå­˜åœ¨é—®é¢˜ï¼‰
```
1. è¯­éŸ³åˆæˆ â†’ ç”ŸæˆåŸå§‹éŸ³é¢‘ç‰‡æ®µ
2. æ‹¼æ¥æ—¶è°ƒæ•´ â†’ ç®€å•å¸§ç‡è°ƒæ•´ï¼ˆéŸ³è´¨å·®ï¼‰
```

### æ–°æµç¨‹ï¼ˆå·²ä¼˜åŒ–ï¼‰
```
1. è¯­éŸ³åˆæˆ â†’ ç”ŸæˆåŸå§‹éŸ³é¢‘ç‰‡æ®µ
2. ç«‹å³å¯¹é½ â†’ ä½¿ç”¨WSOLAç®—æ³•ç²¾ç¡®å¯¹é½
3. èƒŒæ™¯å åŠ  â†’ ç›´æ¥å åŠ åˆ°èƒŒæ™¯éŸ³é¢‘
```

## ğŸ” ä»£ç å®ç°åˆ†æ

### å…³é”®å‡½æ•°ï¼š`adjust_audio_speed`

```python
def adjust_audio_speed(self, audio_file, target_duration, output_file):
    # 1. è¯»å–éŸ³é¢‘å¹¶è®¡ç®—å½“å‰æ—¶é•¿
    audio = AudioSegment.from_wav(audio_file)
    current_duration = len(audio) / 1000.0
    
    # 2. è®¡ç®—é€Ÿåº¦è°ƒæ•´å€ç‡
    speed_rate = current_duration / target_duration
    print(f"å½“å‰æ—¶é•¿={current_duration:.2f}s, ç›®æ ‡æ—¶é•¿={target_duration:.2f}s")
    print(f"é€Ÿåº¦å€ç‡={speed_rate:.2f}")
    
    # 3. å®¹å·®åˆ¤æ–­
    if abs(speed_rate - 1.0) < 0.1:
        return True  # æ— éœ€è°ƒæ•´
    
    # 4. ä½¿ç”¨WSOLAç®—æ³•è¿›è¡Œé«˜è´¨é‡å˜é€Ÿ
    wsola = audiotsm.wsola(1, speed=speed_rate)
    wsola.run(reader, writer)
```

### è°ƒç”¨æ—¶æœºï¼š`synthesize_batch_segments`

```python
# åœ¨æ¯ä¸ªéŸ³é¢‘ç‰‡æ®µåˆæˆåç«‹å³å¯¹é½
for i, (text, start_time, end_time) in enumerate(text_segments):
    # ç¬¬ä¸€æ­¥ï¼šåˆæˆéŸ³é¢‘
    success = self.synthesize_text(text, temp_output, ...)
    
    # ç¬¬äºŒæ­¥ï¼šç«‹å³è¿›è¡Œæ—¶é•¿å¯¹é½
    target_duration = end_time - start_time  # ä»å­—å¹•è·å–ç›®æ ‡æ—¶é•¿
    align_success = self.adjust_audio_speed(temp_output, target_duration, temp_aligned)
```

## ğŸ“Š å¯¹æ¯”åˆ†æ

### æ—¶é•¿å¯¹é½ç²¾åº¦å¯¹æ¯”

| æ–¹æ³• | ç®—æ³• | éŸ³è´¨ä¿æŒ | æ—¶é•¿ç²¾åº¦ | å¤„ç†æ•ˆç‡ |
|------|------|---------|---------|---------|
| **æ—§æ–¹æ³•** | ç®€å•å¸§ç‡è°ƒæ•´ | âŒ å¯èƒ½å¤±çœŸ | âš ï¸ ä¸€èˆ¬ | âœ… å¿«é€Ÿ |
| **æ–°æ–¹æ³•** | WSOLAç®—æ³• | âœ… é«˜è´¨é‡ | âœ… ç²¾ç¡® | âœ… é«˜æ•ˆ |

### å¤„ç†æµç¨‹ä¼˜åŒ–

| é˜¶æ®µ | æ—§æµç¨‹ | æ–°æµç¨‹ | ä¼˜åŒ–æ•ˆæœ |
|------|--------|--------|---------|
| **ç¬¬ä¸€æ¬¡** | ä»…åˆæˆ | åˆæˆ+å¯¹é½ | é¿å…é‡å¤å¤„ç† |
| **ç¬¬äºŒæ¬¡** | è°ƒæ•´+æ‹¼æ¥ | ä»…å åŠ  | ç®€åŒ–é€»è¾‘ |
| **æ•´ä½“** | ä¸¤æ¬¡å¤„ç† | ä¸€æ¬¡å¯¹é½ | æé«˜æ•ˆç‡ |

## ğŸµ éŸ³è´¨ä¿è¯

### WSOLAç®—æ³•ç‰¹ç‚¹
1. **ä¿æŒéŸ³è°ƒ**ï¼šå˜é€Ÿä¸å˜è°ƒ
2. **å‡å°‘å¤±çœŸ**ï¼šé«˜è´¨é‡éŸ³é¢‘å¤„ç†
3. **å¹³æ»‘è¿‡æ¸¡**ï¼šè‡ªç„¶çš„æ—¶é—´æ‹‰ä¼¸/å‹ç¼©

### é¢å¤–ä¼˜åŒ–
- **æ¸å˜æ•ˆæœ**ï¼šéŸ³é¢‘ç‰‡æ®µæ·»åŠ fade in/out
- **èƒŒæ™¯éŸ³ä¿ç•™**ï¼šåŸè§†é¢‘éŸ³é¢‘ä½œä¸ºç¯å¢ƒéŸ³
- **éŸ³é‡è°ƒèŠ‚**ï¼šè¯­éŸ³æ®µæœŸé—´è‡ªåŠ¨é™ä½èƒŒæ™¯éŸ³

## âœ… æ€»ç»“

ä¼˜åŒ–åçš„éŸ³é¢‘æ—¶é•¿å¯¹é½ï¼š

1. **âœ… ç²¾ç¡®å¯¹é½**ï¼šåŸºäºå­—å¹•æ—¶é—´æ®µç²¾ç¡®è®¡ç®—
2. **âœ… é«˜è´¨é‡å¤„ç†**ï¼šä½¿ç”¨WSOLAç®—æ³•ä¿æŒéŸ³è´¨  
3. **âœ… æ™ºèƒ½å®¹å·®**ï¼šå°å¹…å·®å¼‚ä¸è¿›è¡Œè°ƒæ•´
4. **âœ… æµç¨‹ä¼˜åŒ–**ï¼šé¿å…é‡å¤å¤„ç†ï¼Œæé«˜æ•ˆç‡
5. **âœ… å®Œæ•´ä¿ç•™**ï¼šåŸè§†é¢‘ç¯å¢ƒéŸ³ä½œä¸ºèƒŒæ™¯

è¿™æ ·ç¡®ä¿äº†æ¯ä¸ªè¯­éŸ³ç‰‡æ®µéƒ½èƒ½å®Œç¾åŒ¹é…å¯¹åº”çš„å­—å¹•æ—¶é—´æ®µï¼ŒåŒæ—¶ä¿æŒæœ€ä½³çš„éŸ³è´¨æ•ˆæœã€‚ 